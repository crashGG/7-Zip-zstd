name: 7-Zip Cross Compile (Linux → Windows x64)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  cross-compile-linux-to-windows:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        darkmode: [true, false]
        compiler: [gcc] # 优先使用 gcc，clang 交叉编译兼容问题更多
    steps:
      - name: 1. 检出源码（包含子模块 DarkMode/lib）
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: 2. 安装依赖（MinGW-w64 工具链 + 辅助工具）
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y mingw-w64 make wine64 unzip tclsh
          # 验证 MinGW-w64 编译器
          x86_64-w64-mingw32-gcc --version
          x86_64-w64-mingw32-g++ --version

      - name: 3. 下载并安装 UASM 汇编器（合法验证）
        run: |
          wget -q "https://github.com/Terraspace/UASM/releases/download/v2.57r/uasm257_linux64.zip"
          unzip -q uasm257_linux64.zip uasm
          sudo install -m 755 uasm /usr/bin
          # 验证 UASM 安装
          if uasm -h > /dev/null 2>&1; then
            echo "UASM 安装成功"
            uasm 2>&1 | head -n 1
          else
            echo "UASM 安装失败"
            exit 1
          fi

      - name: 4. 配置交叉编译环境变量（核心修正：清理无效选项 + 补充 Windows 宏）
        run: |
          # 定义 MinGW-w64 完整工具链路径
          echo "CC=x86_64-w64-mingw32-gcc" >> $GITHUB_ENV
          echo "CXX=x86_64-w64-mingw32-g++" >> $GITHUB_ENV
          echo "CC_PREFIX=x86_64-w64-mingw32-" >> $GITHUB_ENV
          # 定义输出目录
          echo "OUTDIR=$PWD/CPP/build-win64-${{ matrix.compiler }}-darkmode-${{ matrix.darkmode }}" >> $GITHUB_ENV
          # 暗模式配置
          echo "ZIP7_DARKMODE=$(if [ "${{ matrix.darkmode }}" = "true" ]; then echo 1; else echo 0; fi)" >> $GITHUB_ENV
          # 核心修正 1：移除 -Werror，清理 Linux 特有宏，补充 Windows 兼容宏
          echo "CFLAGS=-static -O2 -m64 -DWIN32 -D_WINDOWS -DZIP7_DARKMODE=$ZIP7_DARKMODE -DNDEBUG -Wall -Wextra -D_WIN32_WINNT=0x0600 -DUNICODE -D_UNICODE" >> $GITHUB_ENV
          echo "CXXFLAGS=-static -O2 -m64 -DWIN32 -D_WINDOWS -DZIP7_DARKMODE=$ZIP7_DARKMODE -DNDEBUG -Wall -Wextra -D_WIN32_WINNT=0x0600 -DUNICODE -D_UNICODE -std=c++17" >> $GITHUB_ENV
          # Windows 链接选项，补充必要系统库
          echo "LDFLAGS=-static -m64 -lkernel32 -luser32 -lgdi32 -lpthread -lws2_32 -ladvapi32" >> $GITHUB_ENV
          # UASM 交叉编译参数（适配 Windows）
          echo "UASM_FLAGS=-nologo -win64 -Fo_o/" >> $GITHUB_ENV

      - name: 5. 进入 CPP 目录，预处理 + 执行构建脚本（核心修正：强制修改 Makefile 参数）
        run: |
          cd ${{ github.workspace }}/CPP
          # 验证 build-lx.sh 和 Makefile 存在
          if [ ! -f "./build-lx.sh" ]; then
            echo "错误：未找到原生构建脚本 build-lx.sh"
            ls -l
            exit 1
          fi
          if [ ! -f "./7zip/7zip_gcc.mak" ]; then
            echo "错误：未找到 Makefile 7zip_gcc.mak"
            ls -l 7zip/
            exit 1
          fi
          chmod +x ./build-lx.sh

          # 核心修正 2：强制修改 Makefile，清理 Linux 特有编译选项和宏
          echo "开始修改 Makefile，移除无效选项..."
          # 1. 移除 -Werror 选项
          sed -i "s/-Werror//g" 7zip/7zip_gcc.mak
          # 2. 移除 Linux 特有宏（_REENTRANT、FILE_OFFSET_BITS 等）
          sed -i "s/-D_REENTRANT//g" 7zip/7zip_gcc.mak
          sed -i "s/-D_FILE_OFFSET_BITS=64//g" 7zip/7zip_gcc.mak
          sed -i "s/-D_LARGEFILE_SOURCE//g" 7zip/7zip_gcc.mak
          # 3. 移除 Linux 特有编译选项（-fPIC、-flto=auto）
          sed -i "s/-fPIC//g" 7zip/7zip_gcc.mak
          sed -i "s/-flto=auto//g" 7zip/7zip_gcc.mak
          # 4. 强制替换 UASM 参数（-elf64 → -win64，移除 -DABI_LINUX）
          sed -i "s/-elf64/-win64/g" 7zip/7zip_gcc.mak
          sed -i "s/-DABI_LINUX//g" 7zip/7zip_gcc.mak
          # 5. 替换 UASM 输出格式，确保与 Windows 编译器兼容
          sed -i "s/Fo_o\//Fo_o\//g" 7zip/7zip_gcc.mak # 保留输出目录，仅修正格式

          # 核心修正 3：显式传递环境变量，执行构建脚本
          env \
            CC="${{ env.CC }}" \
            CXX="${{ env.CXX }}" \
            CC_PREFIX="${{ env.CC_PREFIX }}" \
            OUTDIR="${{ env.OUTDIR }}" \
            CFLAGS="${{ env.CFLAGS }}" \
            CXXFLAGS="${{ env.CXXFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}" \
            UASM_FLAGS="${{ env.UASM_FLAGS }}" \
            ZIP7_DARKMODE="${{ env.ZIP7_DARKMODE }}" \
            ./build-lx.sh

      - name: 6. 验证编译产物
        run: |
          EXE_FILE=$(find ${{ env.OUTDIR }} -name "7z.exe" -type f | head -n 1)
          if [ -f "$EXE_FILE" ]; then
            echo "验证编译产物：$EXE_FILE"
            wine64 "$EXE_FILE" --version
            # 验证产物格式（确认是 Windows x64 可执行文件）
            file "$EXE_FILE"
          else
            echo "错误：未找到生成的 7z.exe 可执行文件"
            ls -l ${{ env.OUTDIR }}
            exit 1
          fi

      - name: 7. 上传编译产物
        uses: actions/upload-artifact@v6
        with:
          name: 7z-win64-${{ matrix.compiler }}-darkmode-${{ matrix.darkmode }}
          path: |
            ${{ env.OUTDIR }}/**/*.exe
            ${{ env.OUTDIR }}/**/*.dll
          retention-days: 7
