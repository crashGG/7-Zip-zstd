# 顶层配置：工作流名称（必需，可自定义）
name: Build binaries
# 顶层配置：触发条件（必需，定义工作流何时运行）
on: [push, pull_request]

# 顶层配置：所有构建任务的容器（必需，不可缺失）
jobs:
  # Linux x64 构建任务（保留你原有的逻辑）
  linux-x64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Configure build system
      run: |
        time wget -q "https://github.com/Terraspace/UASM/releases/download/v2.57r/uasm257_linux64.zip"
        unzip uasm257_linux64.zip uasm
        sudo install -m 755 uasm /usr/bin
    - name: Build via clang
      run: |
        cd ${{ github.workspace }}/CPP
        CC="clang" CXX="clang++" OUTDIR="$PWD/build-clang" ./build-lx.sh
    - name: Build via gcc
      run: |
        cd ${{ github.workspace }}/CPP
        CC="gcc" CXX="g++" OUTDIR="$PWD/build-gcc" ./build-lx.sh
    - name: Test with clang binary
      run: |
        Z7_PATH="CPP/build-clang/7z" tclsh tests/7z-test.tcl -verbose tpsem
    - name: Test with gcc binary
      run: |
        Z7_PATH="CPP/build-gcc/7z" tclsh tests/7z-test.tcl -verbose tpsem
    - name: Upload Build Artifacts (gcc)
      uses: actions/upload-artifact@v6
      with:
        path: ${{ github.workspace }}/CPP/build-gcc/*
        name: linux-gcc-x64
    - name: Upload Build Artifacts (clang)
      uses: actions/upload-artifact@v6
      with:
        path: ${{ github.workspace }}/CPP/build-clang/*
        name: linux-clang-x64

  # Linux arm64 构建任务（保留你原有的逻辑）
  linux-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
    - uses: actions/checkout@v6
    - name: Build via clang
      run: |
        cd ${{ github.workspace }}/CPP
        CC="clang" CXX="clang++" OUTDIR="$PWD/build-clang" ./build-lx.sh
    - name: Build via gcc
      run: |
        cd ${{ github.workspace }}/CPP
        CC="gcc" CXX="g++" OUTDIR="$PWD/build-gcc" ./build-lx.sh
    - name: Test with clang binary
      run: |
        Z7_PATH="CPP/build-clang/7z" tclsh tests/7z-test.tcl -verbose tpsem
    - name: Test with gcc binary
      run: |
        Z7_PATH="CPP/build-gcc/7z" tclsh tests/7z-test.tcl -verbose tpsem
    - name: Upload Build Artifacts (gcc)
      uses: actions/upload-artifact@v6
      with:
        path: ${{ github.workspace }}/CPP/build-gcc/*
        name: linux-gcc-arm64
    - name: Upload Build Artifacts (clang)
      uses: actions/upload-artifact@v6
      with:
        path: ${{ github.workspace }}/CPP/build-clang/*
        name: linux-clang-arm64

  # Windows GCC 构建任务（已修改为 MinGW GCC，嵌套在 jobs 之下）
  windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [ x86, x64, arm64 ]  # GCC 对应架构命名，替换原 MSVC 架构
        darkmode: [darkmode, '']
        include:
          - arch: x86
            subsys: "5.01"
            platform: "x86"
            target: "i686-w64-mingw32"
          - arch: x64
            subsys: "5.02"
            platform: "x64"
            target: "x86_64-w64-mingw32"
          - arch: arm64
            subsys: "6.02"
            platform: "arm64"
            target: "aarch64-w64-mingw32"
    steps:
      - uses: actions/checkout@v6

      # 安装 MinGW GCC 工具链（替换 MSBuild/VC Dev Cmd）
      - name: Install MinGW GCC (Mingw-w64)
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: ${{ matrix.arch }}
          version: latest

      # 预准备依赖（改为 PowerShell 兼容格式）
      - name: Pre-requirements
        shell: powershell
        run: |
          if ("${{ matrix.darkmode }}" -eq "darkmode") {
            if (Test-Path "DarkMode/lib/src") {
              Write-Host "use DarkMode/lib"
            } else {
              Write-Host "checkout darkmodelib module ..."
              git submodule update --init --recursive DarkMode/lib
              if ($LASTEXITCODE -ne 0) {
                Write-Host "checkout module failed, clone ..."
                git clone https://github.com/ozone10/darkmodelib.git DarkMode/lib
              }
            }
          }

      # GCC 编译（参考 Linux 构建的 CC/CXX 环境变量风格）
      - name: Compiling ${{ matrix.arch }} with GCC
        shell: powershell
        run: |
          # 定义基础路径和环境变量
          $WDIR = $PWD.Path
          $PLATFORM = "${{ matrix.arch }}"
          $SUBSYS = "${{ matrix.subsys }}"
          $TARGET = "${{ matrix.target }}"
          $ROOT = Join-Path $WDIR "CPP/7zip"
          $OUTDIR = Join-Path $WDIR "build/bin-$PLATFORM"
          $DARKMODE = "${{ matrix.darkmode }}"

          # 配置 DarkMode 相关参数
          if ($DARKMODE -eq "darkmode") {
            if ($SUBSYS -lt "6.00") { $SUBSYS = "6.00" }
            $env:ZIP7_DARKMODE = 1
          } else {
            $OUTDIR += "-ndm"
            $env:ZIP7_DARKMODE = 0
          }

          # 指定 GCC 编译器（针对 Windows 交叉编译目标）
          $env:CC = "$($TARGET)-gcc"
          $env:CXX = "$($TARGET)-g++"
          $env:OUTDIR = $OUTDIR
          $env:SUBSYS = $SUBSYS
          $env:PLATFORM = $PLATFORM

          # 创建输出目录
          if (-not (Test-Path $OUTDIR)) {
            New-Item -ItemType Directory -Path $OUTDIR | Out-Null
          }

          # 切换到 CPP 目录执行构建脚本
          Set-Location (Join-Path $WDIR "CPP")
          Write-Host "********"
          Write-Host "Working Dir: $WDIR"
          Write-Host "Platform:    $PLATFORM"
          Write-Host "SUBSYS:      $SUBSYS"
          Write-Host "Compiler:    $env:CC"
          Write-Host "Output Dir:  $OUTDIR"

          # 执行 GCC 构建脚本
          bash ./build-lx.sh
          if ($LASTEXITCODE -ne 0) {
            Write-Error "GCC compilation failed with exit code $LASTEXITCODE"
            exit 1
          }

          # 复制发布脚本
          $doReleaseSrc = Join-Path $WDIR ".github/workflows/do-release.cmd"
          $doReleaseDst = Join-Path $WDIR "build/do-release.cmd"
          Copy-Item -Path $doReleaseSrc -Destination $doReleaseDst -Force

      # 测试 GCC 编译产物
      - name: Test
        shell: powershell
        run: |
          $PLATFORM = "${{ matrix.arch }}"
          $DARKMODE = "${{ matrix.darkmode }}"
          $OUTDIR = "build/bin-$PLATFORM"
          if ($DARKMODE -eq "") { $OUTDIR += "-ndm" }
          $env:Z7_PATH = Join-Path $OUTDIR "7z.exe"

          # 执行测试脚本
          tclsh tests/7z-test.tcl -verbose tpsem
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Test failed for $PLATFORM ($DARKMODE)"
            exit 1
          }

      # 上传 GCC 构建产物
      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v6
        with:
          path: ${{ github.workspace }}\build\**\*
          name: binary-${{ matrix.arch }}-${{ matrix.darkmode }}

  # 发布任务（保留你原有的逻辑，嵌套在 jobs 之下）
  do-release:
    runs-on: windows-latest
    needs: windows
    steps:
    - uses: actions/download-artifact@v7
      with:
        path: artifact
        pattern: binary-*
        merge-multiple: true

    - name: Generate binaries for release
      shell: cmd
      run: |
        cd artifact
        do-release.cmd

    - uses: geekyeggo/delete-artifact@v5
      with:
          name: binary-*

    - uses: actions/upload-artifact@v6
      with:
        name: 7-Zip ZS Release binaries
        path: |
          artifact\*.exe
          artifact\*.7z
