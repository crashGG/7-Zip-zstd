# 顶层配置：工作流名称
name: Build binaries
# 顶层配置：触发条件
on: [push, pull_request]

# 顶层配置：所有构建任务容器
jobs:
  # Linux 构建任务（仅保留 x64）
  linux-x64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Configure build system
      run: |
        time wget -q "https://github.com/Terraspace/UASM/releases/download/v2.57r/uasm257_linux64.zip"
        unzip uasm257_linux64.zip uasm
        sudo install -m 755 uasm /usr/bin
    - name: Build via clang
      run: |
        cd ${{ github.workspace }}/CPP
        CC="clang" CXX="clang++" OUTDIR="$PWD/build-clang" ./build-lx.sh
    - name: Build via gcc
      run: |
        cd ${{ github.workspace }}/CPP
        CC="gcc" CXX="g++" OUTDIR="$PWD/build-gcc" ./build-lx.sh
    - name: Test with clang binary
      run: |
        Z7_PATH="CPP/build-clang/7z" tclsh tests/7z-test.tcl -verbose tpsem
    - name: Test with gcc binary
      run: |
        Z7_PATH="CPP/build-gcc/7z" tclsh tests/7z-test.tcl -verbose tpsem
    - name: Upload Build Artifacts (gcc)
      uses: actions/upload-artifact@v6
      with:
        path: ${{ github.workspace }}/CPP/build-gcc/*
        name: linux-gcc-x64
    - name: Upload Build Artifacts (clang)
      uses: actions/upload-artifact@v6
      with:
        path: ${{ github.workspace }}/CPP/build-clang/*
        name: linux-clang-x64

  # Windows 构建任务（修复 PowerShell 5.1 语法兼容，仅 x64）
  windows:
    runs-on: windows-latest
    strategy:
      matrix:
        darkmode: [darkmode, '']
        arch: [x64]
        subsys: ["5.02"]
        platform: ["x64"]
        target: ["x86_64-w64-mingw32"]
    steps:
    - uses: actions/checkout@v6

    # 修复：PowerShell 5.1 兼容的 UASM 安装步骤
    - name: Install UASM (Universal Assembler) for Windows x64
      shell: powershell
      run: |
        $UASM_URL = "https://github.com/Terraspace/UASM/releases/download/v2.57r/uasm257_win64.zip"
        $UASM_ZIP = "$env:TEMP/uasm257_win64.zip"
        $UASM_EXE = "uasm.exe"

        # 下载 UASM
        Write-Host "Downloading UASM from $UASM_URL"
        Invoke-WebRequest -Uri $UASM_URL -OutFile $UASM_ZIP -UseBasicParsing -SilentlyContinue

        # 解压 uasm.exe
        Write-Host "Extracting $UASM_EXE"
        Expand-Archive -Path $UASM_ZIP -DestinationPath $env:TEMP -Force

        # 验证解压结果
        $UASM_PATH = Join-Path $env:TEMP $UASM_EXE
        if (-not (Test-Path $UASM_PATH)) {
          Write-Error "UASM extraction failed, $UASM_EXE not found"
          exit 1
        }

        # 配置 PATH 确保可全局调用（修复：移除 ?.，使用 PowerShell 5.1 兼容写法）
        $env:PATH += ";$env:TEMP"
        $MINGW_CMD = Get-Command "x86_64-w64-mingw32-gcc" -ErrorAction SilentlyContinue
        if ($MINGW_CMD -ne $null) {
          $MINGW_BIN = $MINGW_CMD.DirectoryName
          Copy-Item -Path $UASM_PATH -Destination $MINGW_BIN -Force
          Write-Host "UASM copied to MinGW directory: $MINGW_BIN"
        } else {
          Write-Warning "MinGW GCC not found, UASM only added to TEMP PATH"
        }

        # 验证 UASM 安装
        Write-Host "Verifying UASM installation"
        uasm --version
        if ($LASTEXITCODE -ne 0) {
          Write-Error "UASM verification failed"
          exit 1
        }

    # 安装 MinGW GCC x64
    - name: Install MinGW GCC (Mingw-w64 x64)
      uses: egor-tensin/setup-mingw@v3
      with:
        platform: x64

    # 预准备依赖
    - name: Pre-requirements
      shell: powershell
      run: |
        if ("${{ matrix.darkmode }}" -eq "darkmode") {
          if (Test-Path "DarkMode/lib/src") {
            Write-Host "use DarkMode/lib"
          } else {
            Write-Host "checkout darkmodelib module ..."
            git submodule update --init --recursive DarkMode/lib
            if ($LASTEXITCODE -ne 0) {
              Write-Host "checkout module failed, clone ..."
              git clone https://github.com/ozone10/darkmodelib.git DarkMode/lib
            }
          }
        }

    # GCC 编译 x64
    - name: Compiling x64 with GCC
      shell: powershell
      run: |
        $TARGET = "${{ matrix.target }}"
        $CC_PATH = "$($TARGET)-gcc"
        $CXX_PATH = "$($TARGET)-g++"
        
        try {
          & $CC_PATH --version
          if ($LASTEXITCODE -ne 0) {
            Write-Error "GCC 编译器 $CC_PATH 不存在，安装失败"
            exit 1
          }
          & $CXX_PATH --version
          if ($LASTEXITCODE -ne 0) {
            Write-Error "G++ 编译器 $CXX_PATH 不存在，安装失败"
            exit 1
          }
        }
        catch {
          Write-Error "无法执行编译器 $CC_PATH，MinGW 安装不完整"
          exit 1
        }

        $WDIR = $PWD.Path
        $PLATFORM = "${{ matrix.platform }}"
        $SUBSYS = "${{ matrix.subsys }}"
        $OUTDIR = Join-Path $WDIR "build/bin-$PLATFORM"
        $DARKMODE = "${{ matrix.darkmode }}"

        if ($DARKMODE -eq "darkmode") {
          if ($SUBSYS -lt "6.00") { $SUBSYS = "6.00" }
          $env:ZIP7_DARKMODE = 1
        } else {
          $OUTDIR += "-ndm"
          $env:ZIP7_DARKMODE = 0
        }

        $env:CC = "$($TARGET)-gcc"
        $env:CXX = "$($TARGET)-g++"
        $env:OUTDIR = $OUTDIR
        $env:SUBSYS = $SUBSYS
        $env:PLATFORM = $PLATFORM

        if (-not (Test-Path $OUTDIR)) {
          New-Item -ItemType Directory -Path $OUTDIR | Out-Null
        }

        Set-Location (Join-Path $WDIR "CPP")
        Write-Host "********"
        Write-Host "Working Dir: $WDIR"
        Write-Host "Platform:    $PLATFORM"
        Write-Host "SUBSYS:      $SUBSYS"
        Write-Host "Compiler:    $env:CC"
        Write-Host "Output Dir:  $OUTDIR"

        bash ./build-lx.sh
        if ($LASTEXITCODE -ne 0) {
          Write-Error "GCC compilation failed with exit code $LASTEXITCODE"
          exit 1
        }

        $doReleaseSrc = Join-Path $WDIR ".github/workflows/do-release.cmd"
        $doReleaseDst = Join-Path $WDIR "build/do-release.cmd"
        Copy-Item -Path $doReleaseSrc -Destination $doReleaseDst -Force

    # 测试 x64 产物
    - name: Test x64 binary
      shell: powershell
      run: |
        $PLATFORM = "${{ matrix.platform }}"
        $DARKMODE = "${{ matrix.darkmode }}"
        $OUTDIR = "build/bin-$PLATFORM"
        if ($DARKMODE -eq "") { $OUTDIR += "-ndm" }
        $env:Z7_PATH = Join-Path $OUTDIR "7z.exe"

        tclsh tests/7z-test.tcl -verbose tpsem
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Test failed for x64 ($DARKMODE)"
          exit 1
        }

    # 上传 x64 产物
    - name: Upload x64 Build Artifact
      uses: actions/upload-artifact@v6
      with:
        path: ${{ github.workspace }}\build\**\*
        name: binary-x64-${{ matrix.darkmode }}

  # 发布任务
  do-release:
    runs-on: windows-latest
    needs: windows
    steps:
    - uses: actions/download-artifact@v7
      with:
        path: artifact
        pattern: binary-x64-*
        merge-multiple: true

    - name: Generate binaries for release
      shell: cmd
      run: |
        cd artifact
        do-release.cmd

    - uses: geekyeggo/delete-artifact@v5
      with:
          name: binary-x64-*

    - uses: actions/upload-artifact@v6
      with:
        name: 7-Zip ZS Release binaries (x64)
        path: |
          artifact\*.exe
          artifact\*.7z
