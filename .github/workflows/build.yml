name: 7-Zip Cross Compile (Linux → Windows x64)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  cross-compile-linux-to-windows:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        darkmode: [true, false]
        compiler: [gcc, clang] # 仅保留 gcc 更稳定，clang 交叉编译需额外配置
    steps:
      - name: 1. 检出源码（包含子模块 DarkMode/lib）
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: 2. 安装依赖（MinGW-w64 工具链 + 辅助工具）
        run: |
          sudo apt update && sudo apt upgrade -y
          # 安装完整的 MinGW-w64 工具链，包含汇编器和编译依赖
          sudo apt install -y mingw-w64 make wine64 unzip tclsh
          # 验证 MinGW-w64 编译器（明确完整路径）
          x86_64-w64-mingw32-gcc --version
          x86_64-w64-mingw32-g++ --version

      - name: 3. 下载并安装 UASM 汇编器（修正：合法验证）
        run: |
          wget -q "https://github.com/Terraspace/UASM/releases/download/v2.57r/uasm257_linux64.zip"
          unzip -q uasm257_linux64.zip uasm
          sudo install -m 755 uasm /usr/bin
          # 验证 UASM 安装
          if uasm -h > /dev/null 2>&1; then
            echo "UASM 安装成功"
            uasm 2>&1 | head -n 1
          else
            echo "UASM 安装失败"
            exit 1
          fi

      - name: 4. 配置交叉编译环境变量（核心修正：明确完整路径 + 替换占位符）
        run: |
          # 定义 MinGW-w64 完整工具链路径（关键：避免占位符无法解析）
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            # 明确指定完整编译器路径，直接替换 {CC} 占位符
            echo "CC=x86_64-w64-mingw32-gcc" >> $GITHUB_ENV
            echo "CXX=x86_64-w64-mingw32-g++" >> $GITHUB_ENV
            echo "CC_PREFIX=x86_64-w64-mingw32-" >> $GITHUB_ENV
          else
            echo "CC=x86_64-w64-mingw32-clang" >> $GITHUB_ENV
            echo "CXX=x86_64-w64-mingw32-clang++" >> $GITHUB_ENV
            echo "CC_PREFIX=x86_64-w64-mingw32-" >> $GITHUB_ENV
          fi
          # 定义输出目录
          echo "OUTDIR=$PWD/CPP/build-win64-${{ matrix.compiler }}-darkmode-${{ matrix.darkmode }}" >> $GITHUB_ENV
          # 暗模式配置
          echo "ZIP7_DARKMODE=$(if [ "${{ matrix.darkmode }}" = "true" ]; then echo 1; else echo 0; fi)" >> $GITHUB_ENV
          # 修正：Windows 交叉编译 CFLAGS/CXXFLAGS，移除 Linux 特有选项
          echo "CFLAGS=-static -O2 -m64 -DWIN32 -D_WINDOWS -DZIP7_DARKMODE=$ZIP7_DARKMODE -DNDEBUG -Wall -Wextra" >> $GITHUB_ENV
          echo "CXXFLAGS=-static -O2 -m64 -DWIN32 -D_WINDOWS -DZIP7_DARKMODE=$ZIP7_DARKMODE -DNDEBUG -Wall -Wextra -std=c++17" >> $GITHUB_ENV
          # Windows 链接选项，链接必要的系统库
          echo "LDFLAGS=-static -m64 -lkernel32 -luser32 -lgdi32 -lpthread -lws2_32" >> $GITHUB_ENV
          # 定义 UASM 交叉编译参数（适配 Windows）
          echo "UASM_FLAGS=-nologo -win64 -Fo_o/" >> $GITHUB_ENV

      - name: 5. 进入 CPP 目录，执行原生构建脚本（核心修正：传递环境变量 + 替换占位符）
        run: |
          cd ${{ github.workspace }}/CPP
          # 验证 build-lx.sh 存在
          if [ ! -f "./build-lx.sh" ]; then
            echo "错误：未找到原生构建脚本 build-lx.sh"
            ls -l
            exit 1
          fi
          chmod +x ./build-lx.sh
          # 修正：直接通过环境变量注入 Makefile，强制替换 {CC}/{CXX} 占位符
          # 方式 1：使用 env 命令传递所有环境变量，确保 make 子进程继承
          env \
            CC="${{ env.CC }}" \
            CXX="${{ env.CXX }}" \
            CC_PREFIX="${{ env.CC_PREFIX }}" \
            OUTDIR="${{ env.OUTDIR }}" \
            CFLAGS="${{ env.CFLAGS }}" \
            CXXFLAGS="${{ env.CXXFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}" \
            UASM_FLAGS="${{ env.UASM_FLAGS }}" \
            ZIP7_DARKMODE="${{ env.ZIP7_DARKMODE }}" \
            ./build-lx.sh
          # 方式 2：若方式 1 仍有问题，直接修改 Makefile 占位符（临时替换）
          # sed -i "s/{CC}/${{ env.CC }}/g" 7zip/7zip_gcc.mak
          # sed -i "s/{CXX}/${{ env.CXX }}/g" 7zip/7zip_gcc.mak
          # ./build-lx.sh

      - name: 6. 验证编译产物
        run: |
          EXE_FILE=$(find ${{ env.OUTDIR }} -name "7z.exe" -type f | head -n 1)
          if [ -f "$EXE_FILE" ]; then
            echo "验证编译产物：$EXE_FILE"
            wine64 "$EXE_FILE" --version
          else
            echo "错误：未找到生成的 7z.exe 可执行文件"
            ls -l ${{ env.OUTDIR }}
            exit 1
          fi

      - name: 7. 上传编译产物
        uses: actions/upload-artifact@v6
        with:
          name: 7z-win64-${{ matrix.compiler }}-darkmode-${{ matrix.darkmode }}
          path: |
            ${{ env.OUTDIR }}/**/*.exe
            ${{ env.OUTDIR }}/**/*.dll
          retention-days: 7
